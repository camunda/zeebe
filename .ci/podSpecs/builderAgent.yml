metadata:
  labels:
    agent: optimize-ci-build
spec:
  nodeSelector:
    cloud.google.com/gke-nodepool: agents-n1-standard-16-netssd-preempt
  tolerations:
    - key: "agents-n1-standard-16-netssd-preempt"
      operator: "Exists"
      effect: "NoSchedule"
  containers:
  - name: maven
    image: maven:3.8.5-openjdk-17-slim
    command: ["cat"]
    tty: true
    env:
      - name: LIMITS_CPU
        valueFrom:
          resourceFieldRef:
            resource: limits.cpu
      - name: TZ
        value: Europe/Berlin
    resources:
      limits:
        cpu: 6
        memory: 4Gi
      requests:
        cpu: 6
        memory: 4Gi
  # this docker-in-docker container is used to spawn containers dynamically inside a docker container
  - name: dind
    image: docker:20.10.16-dind
    args: ["--storage-driver=overlay2"]
    securityContext:
      privileged: true
    env:
      # This disabled automatic TLS setup as this is not exposed to the network anyway
      - name: DOCKER_TLS_CERTDIR
        value: ""
    tty: true
    resources:
      limits:
        cpu: 1
        memory: 1Gi
      requests:
        cpu: 1
        memory: 1Gi
    # this docker image is used for docker cli as it ships with additional tooling like buildx for multiplatform builds
  - name: docker
    image: crazymax/docker:20.10.16
    command: ["/bin/bash"]
    env:
      - name: DOCKER_HOST
        value: tcp://localhost:2375
    tty: true
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 500m
        memory: 256Mi
  - name: node
    image: node:14.15.4-alpine
    command: ["cat"]
    tty: true
    env:
      - name: LIMITS_CPU
        valueFrom:
          resourceFieldRef:
            resource: limits.cpu
    resources:
      limits:
        cpu: 4
        memory: 4Gi
      requests:
        cpu: 4
        memory: 4Gi
